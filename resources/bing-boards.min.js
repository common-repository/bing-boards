(function(l,a,m){a(document).ready(function(){var b={data:{char_limit_content:BingBoards.body_char_limit,char_limit_title:BingBoards.panel_title_char_limit,char_limit_board:BingBoards.board_title_char_limit,char_limit_link:BingBoards.link_title_char_limit,char_min_search_terms:BingBoards.search_term_min_chars,char_max_search_terms:BingBoards.search_term_max_chars,panels_limit:BingBoards.panels_limit,doing_ajax:!1,last_serialized:[],panels:[],v_height:0,v_width:0,user_has_bing_key:BingBoards.user_has_bing_key,
submit_errors:BingBoards.submit_errors,first_save:!1},el:{body:a("body"),editor:a("#bing-live-editor").clone(),list:a("#bing-panels-list"),new_panel:a(".bing-new-panel-button-container"),overlay:{},panel_options:a(".bing-new-panel-options"),title:a("#title"),titlewrap:a("#titlewrap"),submit:a("input.can-api"),nosubmit:a("p.no-can-api")},fn:{array_diff:function(b){var a={},f=arguments.length,e="",g=1,k="",h={};a:for(e in b)for(g=1;g<f;g++){h=arguments[g];for(k in h)if(h[k]===b[e])continue a;a[e]=b[e]}return a},
ays:function(){var c=b.fn.serialize(),c=a.extend(b.fn.array_diff(b.data.last_serialized,c),b.fn.array_diff(c,b.data.last_serialized));return a.isEmptyObject(c)?!0:confirm(BingBoards.txt_ays)},can_api:function(){if(b.data.first_save){var c=null,d=a("input.bing-search-term"),f=a(".bing-panel");""==b.el.title.val()&&(c=b.data.submit_errors[0]);b.el.title.hasClass("bad")&&(c=b.data.submit_errors[1]);b.data.user_has_bing_key||(c=b.data.submit_errors[2]);a(".panel-error").length&&(c=b.data.submit_errors[3]);
f.length||(c=b.data.submit_errors[4]);var e=a.map(d,function(b,c){return a(b).val()}).join("");""==a.trim(e)&&(c=b.data.submit_errors[5]);e=a.map(d,function(c,d){var e=a(c).val();return e.length&&(e.length<b.data.char_min_search_terms||e.length>b.data.char_max_search_terms)?e:""}).join("");""!=a.trim(e)&&(c=b.data.submit_errors[6]);f.length>b.data.panels_limit&&(c=b.data.submit_errors[7]);if(null!==c)return b.el.nosubmit.html(c),b.el.nosubmit.show(),b.el.submit.attr("disabled","disabled"),!1;b.el.submit.removeAttr("disabled");
b.el.nosubmit.hide();return!0}},carousel:function(){b.fn.get_panels();var c=a("#panel-slider ul");c.empty();a(b.data.panels).each(function(){var b='<li><a class="carousel-link cl-'+this.id+'" data-id="'+this.id+'" href="#" title="'+this.title+'">';this.img.length&&(b+='<img src="'+this.img+'" alt="thumb" />');c.append(b+"</a></li>")});c.append('<li><a href="#" id="carousel-new-panel"><span>'+BingBoards.txt_create_new_panel+"</span></a></li>");a("#panel-slider").jcarousel()},carousel_current:function(){a("#panel-slider").jcarousel("scroll",
a("#panel-slider .current"),!1)},carousel_nav:function(b){b.preventDefault();var d="-";"panel-slider-right"==b.currentTarget.id&&(d="+");a("#panel-slider").jcarousel("scroll",d+"=1")},carousel_new:function(){b.fn.ays()&&(b.fn.dialog(),b.fn.carousel(),a("#bing-live-editor").addClass("from-scratch, first-run").show(),b.el.overlay.show(),b.fn.save_panel())},char_count:function(c,d,f){if(c){d=a(d);var e=c.val().length,g=f-e;d.show();e>f?(d.text(g).removeClass("good").addClass("bad"),c.addClass("bad")):
(d.text(g).removeClass("bad").addClass("good"),c.removeClass("bad"))}else c=a("#panel-title"),f=a("#panel-content"),d=a("#blp-title"),e=a("#panel-link-edit"),g=b.el.title,g.val().length>b.data.char_limit_board?g.addClass("bad"):g.removeClass("bad"),c.val().length>b.data.char_limit_title&&c.addClass("bad"),f.val().length>b.data.char_limit_content&&f.addClass("bad"),d.length&&d.val().length>b.data.char_limit_link?d.addClass("bad"):d.length&&d.removeClass("bad"),e.length&&e.text().length>b.data.char_limit_link?
e.addClass("bad"):e.length&&e.removeClass("bad");b.fn.validate_empty();b.fn.can_api()},char_hide:function(b){a(b).hide()},close_editor:function(){b.fn.ays()&&(b.fn.hide_link_picker(!1),a("#bing-live-editor").hide(),b.el.overlay.hide())},close_frame:function(){var c,d=a("#thumb-id");switch(b.frame.state().get("id")){case "insert":c=b.frame.state().get("selection").first();if(!c)return;c=c.toJSON();d.val(c.id);d=a("<img>").attr("src",c.url);a("#panel-image-wrap").empty().append(d);break;case "embed":c=
b.frame.state().props.toJSON();if(!c)return;if(!c.embed_html&&!c.bad_url)d.val(c.url),d=a("<img>").attr("src",c.url),a("#panel-image-wrap").empty().append(d);else if(!c.bad_url){var f=a("#panel-title"),e=a("#panel-content"),g=a("#panel-link-kill");a("#panel-image-wrap").empty().append(c.embed_html);a("#thumb-embed").val(c.embed_html);d.val(c.thumb_url);f.val().length||f.val(c.embed_title);e.val().length||e.val(c.embed_desc);g.length||(a("#panel-link-url").val(c.embed_url),a("#panel-link-anchor").val(c.embed_title),
a("#panel-link-edit").text(b.fn.html_decode(c.embed_title)).removeClass("no-link"),a(".panel-inputs").append('<span id="panel-link-kill" class="icon-close"></span>'))}}c&&(a("#bing-live-editor").addClass("has-image"),a("#bing-insert-media").text(BingBoards.txt_replace_image),b.fn.save_panel())},content_update:function(a){b.tests.isie10()&&a.val()==a.data("pl")&&a.val("");b.fn.resize_textarea(a);b.fn.char_count(a,"#bing-content-count",b.data.char_limit_content)},create_panel:function(c){c.preventDefault();
var d="from-post";"new-panel-from-scratch"==c.currentTarget.id&&(d="from-scratch");b.fn.dialog();a("#bing-live-editor").addClass(d).show();b.el.overlay.show();"from-scratch"==d?(b.fn.save_panel(),a("#bing-live-editor").addClass("first-run"),a("#bing-link-count").text("").removeClass("bad good")):(b.fn.snapshot(),a("#bing-live-editor-board-title").text(BingBoards.txt_new_panel_from_post),b.fn.carousel(),b.fn.post_scrape_search(),a("#bing-live-editor").addClass("first-run"));b.el.panel_options.toggle()},
delete_panel:function(c){confirm(BingBoards.txt_ays_delete)&&(b.fn.show_overlay(),a.post(ajaxurl,{action:"bing-delete-panel",panel_id:c,nonce:BingBoards.delete_panel_nonce},function(d){d.success?(b.fn.hide_overlay(),a("#bing-panel-"+c).remove(),b.fn.can_api()):(b.fn.hide_overlay(),alert(d.message))}))},dialog:function(){a("#bing-live-editor").remove();b.el.body.append(b.el.editor.clone());a("#bing-live-editor-board-title").text(a("#title").val());b.fn.legacy()},disable_save:function(){a("#bing-live-editor-save").attr("disabled",
"disabled")},enable_save:function(){a("#bing-live-editor-save").removeAttr("disabled")},get_panels:function(){b.data.panels=[];a(".bing-panel").each(function(){var c={},d=a(this),f=d.find(".bing-panel-permalink"),e=f.text(),f=f.data("id"),g="";d.find(".thumbnail").length&&(g=d.find(".thumbnail").data("thumb"));c.id=f;c.title=e;c.img=g;b.data.panels.push(c)})},get_embed:function(c,d){var f=c.props.get("url"),e=f.toLowerCase(),g=a.Deferred(),k=a(".media-frame .embed-url input"),h=a("div.embed-link-settings");
0<=e.indexOf("youtube")||0<=e.indexOf("youtu.be")||0<=e.indexOf("vimeo")?(b.fn.show_overlay(),d.scanners.push(g.promise()),a.post(ajaxurl,{action:"bing-oembed",url:f,nonce:BingBoards.embed_nonce},function(a){b.fn.hide_overlay();a.success?(c.set({type:"bing-embed"}),a.data.html?(c.props.set({embed_title:a.data.title,thumb_url:a.data.thumbnail,embed_desc:a.data.description,embed_url:a.data.url,embed_html:a.data.html,bad_url:!1}),h.empty(),h.append(a.data.html),k.removeClass("embed-error")):(c.props.set({url:!1,
embed_title:!1,thumb_url:!1,embed_url:!1,embed_html:!1,bad_url:!0}),k.addClass("embed-error")),g.resolve()):g.reject()})):(h.empty(),c.props.set({url:!1,embed_title:!1,thumb_url:!1,embed_url:!1,embed_html:!1,bad_url:!0}),k.addClass("embed-error"),g.resolve())},hide_link_picker:function(b){a("#bing-link-picker").is(".modified")&&!b?confirm(BingBoards.txt_ays)&&(a("#bing-live-editor").removeClass("blp-active"),a("#bing-link-picker").hide()):(a("#bing-live-editor").removeClass("blp-active"),a("#bing-link-picker").removeClass("modified").hide())},
hide_overlay:function(){a(".panel-overlay").remove()},html_decode:function(b){return a("<div/>").html(b).text()},insert_board_title_counter:function(){b.el.titlewrap.append('<span id="bing-board-count" class="character-warn"></span>')},insert_link:function(){var c=a("#blp-url"),d=a("#blp-title"),c=c.val(),d=d.val();c.length&&(d.length||(d=c),a("#panel-link-url").val(c),a("#panel-link-anchor").val(d),a("#panel-link-edit").text(b.fn.html_decode(d)).removeClass("no-link"),a("#panel-link-kill").length||
a(".panel-inputs").append('<span id="panel-link-kill" class="icon-close"></span>'),b.fn.enable_save(),b.fn.hide_link_picker(!0))},legacy:function(){a("#panel-title, #panel-content").placeholder()},link_picker_tests:function(b){if(10==b.keyCode||13==b.keyCode)b.stopPropagation(),b.preventDefault();a("#bing-link-picker").is(".modified")||a("#bing-link-picker").addClass("modified")},load_link_picker:function(){a("#bing-live-editor").addClass("blp-active");a("#blp-url").val(a("#panel-link-url").val());
a("#blp-title").val(a("#panel-link-anchor").val());a("#bing-link-picker").show();b.fn.char_count(null);b.fn.post_link_search()},load_panel:function(c,d,f){d&&b.fn.show_overlay();a.post(ajaxurl,{action:"bing-get-panel",panel_id:c},function(c){if(c.success){a("#bing-live-editor").hide();f&&b.el.list.html(f);b.fn.dialog();b.fn.hide_overlay();var d=a("#panel-content"),k=a("#bing-live-editor"),h=a("#panel-link-edit");k.show();b.el.overlay.show();a("#panel-id").val(c.data.ID);a("#panel-title").val(b.fn.html_decode(c.data.post_title));
d.val(b.fn.html_decode(c.data.post_excerpt));a("#bing-last-modified").text(c.data.last_modified);a("#panel-link-set, #panel-link-kill").remove();h.show().addClass("no-link");b.fn.resize_textarea(d);b.fn.carousel();a(".cl-"+c.data.ID).parent().addClass("current");b.fn.carousel_current();c.data.link_url&&(d=c.data.link_anchor?b.fn.html_decode(c.data.link_anchor):c.data.link_url,h.text(b.fn.html_decode(d)).removeClass("no-link"),a(".panel-inputs").append('<span id="panel-link-kill" class="icon-close"></span>'),
a("#panel-link-url").val(c.data.link_url),c.data.link_anchor&&a("#panel-link-anchor").val(b.fn.html_decode(c.data.link_anchor)));b.fn.validate_empty();b.fn.char_count(null);c.data.thumbnail_embed?(k.addClass("has-image"),a("#bing-insert-media").text(BingBoards.txt_replace_image).prepend('<span class="wp-media-buttons-icon"></span>'),a("#panel-image-wrap").empty().append(c.data.thumbnail_embed),a("#thumb-embed").val(c.data.thumbnail_embed),a("#thumb-id").val(c.data.thumbnail)):c.data.thumbnail&&(h=
a("<img>").attr("src",c.data.thumbnail),a("#panel-image-wrap").empty().append(h),k.addClass("has-image"),a("#bing-insert-media").text(BingBoards.txt_replace_image).prepend('<span class="wp-media-buttons-icon"></span>'));c.data.thumbnail_id&&a("#thumb-id").val(c.data.thumbnail_id);a("p.while-scrapping").hide();b.fn.snapshot()}else alert(c.message)})},post_link_search:function(c){b.data.doing_ajax||(a("#blp-posts-wrapper").spin("small","#333"),a("#blp-posts").empty(),c||(c=""),b.data.doing_ajax=!0,
a.post(ajaxurl,{action:"bing-posts-for-linking",s:c},function(c){a("#blp-posts-wrapper").spin(!1);c.success?(a.each(c.data,function(b,c){var d='<li><a href="#" data-title="'+c.title+'" data-link="'+c.link+'" class="bing-post-link">',d=c.img!==m&&c.img.length?d+('<span class="scrape-thumb"><img src="'+c.img+'" data-id="'+c.ID+'" /></span>'):d+'<span class="scrape-thumb"></span>',d=d+('<span class="scrape-title">'+c.title+"</span></a>");a("#blp-posts").append(d)}),a("#blp-posts").fadeIn(200)):alert(c.message);
b.data.doing_ajax=!1}))},post_scrape_search:function(c){b.data.doing_ajax||(a("#posts-wrapper").spin("small","#333"),a("#posts-for-scrapping").empty(),c||(c=""),b.data.doing_ajax=!0,a.post(ajaxurl,{action:"bing-posts-for-scrapping",board_id:a("#post_ID").val(),s:c},function(c){c.success?(a("#posts-wrapper").spin(!1),a.each(c.data,function(b,c){var d='<li><a href="#" data-id="'+c.ID+'" class="bing-post-scrap">',d=c.img!==m&&c.img.length?d+('<span class="scrape-thumb"><img src="'+c.img+'" data-id="'+
c.ID+'" /></span>'):d+'<span class="scrape-thumb"></span>',d=d+('<span class="scrape-title">'+c.title+"</span></a>");a("#posts-for-scrapping").append(d)}),a("#posts-for-scrapping").fadeIn(200)):(a("#posts-wrapper").spin(!1),alert(c.message));b.data.doing_ajax=!1}))},remove_link:function(){a("#panel-link-set, #panel-link-kill").remove();a("#panel-link-edit").text(BingBoards.txt_choose_link).addClass("no-link");a("#panel-link-url, #panel-link-anchor").val("");b.fn.enable_save();b.fn.validate_empty()},
resize_textarea:function(a){a.css({height:"auto"});if(""!==a.val()){var d=a[0].scrollHeight;b.tests.webkit()&&(d-=16);180>d?a.height(d).css("overflow","hidden"):a.height(180).css("overflow","auto")}},save_panel:function(){b.fn.show_overlay();var c=a("#panel-id").val(),d=0,d=c.length?a('.bing-panel-permalink[data-id="'+c+'"]').index(".bing-panel-permalink")+1:a(".bing-panel-permalink").length+1;a.post(ajaxurl,{action:"bing-add-panel",nonce:BingBoards.add_panel_nonce,panel_id:c,panel_title:b.fn.html_decode(a("#panel-title").val()),
panel_content:b.fn.html_decode(a("#panel-content").val()),panel_link_url:a("#panel-link-url").val(),panel_link_anchor:b.fn.html_decode(a("#panel-link-anchor").val()),thumb_id:a("#thumb-id").val(),thumb_embed:a("#thumb-embed").val(),board_id:a("#post_ID").val(),menu_order:d},function(c){b.fn.hide_overlay();c.success?(b.el.list.html(c.data.panels),b.fn.setup_panel(),a("#bing-last-modified").text(c.data.last_modified),a("#panel-id").val(c.data.id),a(".cl-"+c.data.id).parent().addClass("current"),b.fn.carousel_current(),
b.fn.snapshot()):alert(c.message)})},scrape_post:function(c){b.fn.show_overlay();a.post(ajaxurl,{action:"bing-scrap-local-post",board_id:a("#post_ID").val(),post_id:c.attr("data-id"),menu_order:a(".bing-panel-permalink").length+1,nonce:BingBoards.scrap_post_nonce},function(c){if(c.success){var f=a(c.data).find(".bing-panel-permalink").last().data("id");b.fn.load_panel(f,!1,c.data)}else b.fn.hide_overlay(),alert(c.message)})},send_panels:function(){a.post(ajaxurl,{action:"bing-panels-sort",nonce:BingBoards.sort_nonce,
panels:a("#bing-panels-list").sortable("toArray")})},serialize:function(){var c=[];a(".bing-serialize-me").each(function(b,f){var e=a(f),g=e.attr("name");c[g]=e.val()});b.fn.validate_empty();return c},setup_panel:function(){b.fn.resize_textarea(a("#panel-content"));b.fn.char_count(null);b.fn.carousel()},show_overlay:function(){b.el.body.append('<div class="panel-overlay"><div class="panel-loader" style="height:'+b.data.v_height+"px; width:"+b.data.v_width+'px"></div></div>');a(".panel-loader").append('<span class="spinbg"></span>').spin("large",
"#fff")},snapshot:function(){b.data.last_serialized=b.fn.serialize()},toggle_button:function(a,d){a.preventDefault();d.hasClass("no-round-bottom")?d.removeClass("no-round-bottom"):d.addClass("no-round-bottom");b.el.panel_options.toggle()},update_data:function(){b.data.v_height=a(l).height();b.data.v_width=a(l).width()},use_link:function(b){var d=b.data("link");b=b.data("title");var f=a("#blp-url"),e=a("#blp-title");f.val(d);e.val(b)},validate_empty:function(){var b=a("#panel-title"),d=a("#panel-content"),
f=a("#panel-image-wrap"),e=f.parents(".panel-media"),g=a("#panel-link-edit");""===b.val()?b.addClass("empty"):b.removeClass("empty");""===d.val()?d.addClass("empty"):d.removeClass("empty");""===f.html()?e.addClass("empty"):e.removeClass("empty");g.is(".no-link")?g.addClass("empty"):g.removeClass("empty")}},frame:wp.media({frame:"post",state:"insert",multiple:!1,library:{type:"image"},editing:!0}),tests:{isie10:function(){return!!("onpropertychange"in document&&l.matchMedia)},webkit:function(){return!!("webkitRequestAnimationFrame"in
l)}},init:function(){b.fn.can_api();b.el.body.append(a("#bing-live-editor")).append('<div class="bing-overlay"></div>');b.el.overlay=a(".bing-overlay");b.fn.update_data();b.fn.get_panels();b.fn.resize_textarea(a("#panel-content"));b.fn.legacy();b.fn.insert_board_title_counter();b.fn.char_count(null);b.el.list.sortable({handle:".icon-menu"}).disableSelection().on("sortupdate",function(){b.fn.send_panels()}).on("click",".bing-panel-permalink, .thumbnail",function(c){c.preventDefault();b.fn.load_panel(a(this).attr("data-id"),
!0,null)}).on("click",".bing-panel .icon-close",function(c){c.preventDefault();b.fn.delete_panel(a(this).attr("data-id"))});b.frame.states.get("embed").on("scan",function(a){b.fn.get_embed(this,a)});b.frame.on("close",function(){b.fn.close_frame()});b.el.new_panel.on("click","#bing-new-panel-button",function(c){b.fn.toggle_button(c,a(this))}).on("click","#new-panel-from-scratch, #new-panel-from-post",function(a){b.fn.create_panel(a)});b.el.body.on("keyup focus","#panel-content",function(){b.fn.content_update(a(this))}).on("blur",
"#panel-content",function(){b.fn.char_hide("#bing-content-count")}).on("keyup",".bing-serialize-me",function(){b.fn.enable_save()}).on("keyup focus","#panel-title",function(){b.fn.char_count(a(this),"#bing-title-count",b.data.char_limit_title)}).on("blur","#panel-title",function(){b.fn.char_hide("#bing-title-count")}).on("keyup focus","#blp-title",function(){b.fn.char_count(a(this),"#bing-link-count",b.data.char_limit_link)}).on("keydown","#blp-title, #blp-url, #blp-search",function(a){b.fn.link_picker_tests(a)}).on("blur",
"#blp-title",function(){b.fn.char_hide("#bing-link-count")}).on("keyup focus","#title",function(){b.fn.char_count(a(this),"#bing-board-count",b.data.char_limit_board)}).on("keyup focus","input.bing-search-term",function(){b.fn.can_api()}).on("blur","#title",function(){b.fn.char_hide("#bing-board-count")}).on("click","#bing-insert-media",function(a){a.preventDefault();b.frame.open();b.fn.enable_save()}).on("click","#bing-live-editor-save",function(){b.fn.show_overlay();b.fn.save_panel();b.fn.disable_save()}).on("click",
"#panel-link-edit",function(a){a.preventDefault();b.fn.load_link_picker()}).on("click","#bing-close-le",function(a){a.preventDefault();a.stopPropagation();b.fn.hide_link_picker(!1)}).on("keyup","#blp-search",function(){b.fn.post_link_search(a(this).val())}).on("click",".bing-post-link",function(c){c.preventDefault();b.fn.use_link(a(this));b.fn.char_count(a("#blp-title"),"#bing-link-count",b.data.char_limit_link)}).on("click","#bing-link-insert",function(a){a.preventDefault();b.fn.insert_link();b.fn.char_count(null)}).on("click",
"#panel-slider-left, #panel-slider-right",function(a){b.fn.carousel_nav(a)}).on("click",".bing-post-scrap",function(c){c.preventDefault();b.fn.scrape_post(a(this))}).on("keyup","#panel-scrapper-search",function(){b.fn.post_scrape_search(a(this).val())}).on("click",".carousel-link",function(c){c.preventDefault();b.fn.ays()&&b.fn.load_panel(a(this).data("id"),!0,null)}).on("click","#panel-link-kill",function(){b.fn.remove_link()}).on("click","a.live-editor-close, .bing-overlay",function(a){a.preventDefault();
b.fn.close_editor()}).on("click","#carousel-new-panel",function(a){a.preventDefault();b.fn.carousel_new()}).on("change","#post_author_override",function(c){a.post(ajaxurl,{action:"bing-user-has-key",user_id:a(this).val(),nonce:BingBoards.user_has_bing_key_nonce},function(a){a.success&&(b.data.user_has_bing_key=a.data.user_has_bing_key,b.data.submit_errors[2]=a.data.message,b.fn.can_api())})}).on("submit","form#post",function(c){b.data.first_save=!0;c=b.fn.can_api();c||(a("#publish").removeClass("button-primary-disabled"),
a("#save-post").removeClass("button-disabled").next(".spinner").attr("style",""),a("#publishing-action .spinner").hide());return c});a(l).resize(function(){b.fn.update_data()})}};b.init()})})(window,jQuery);
